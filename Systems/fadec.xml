<?xml version="1.0"?>
<?xml-stylesheet href="JSBSim.xsl" type="application/xml"?>

<!--
    :copyright: 2024, IAHM-COL
    :copyright: 2024, David Waggoner (Skyboat)
    License: GPLv3

    Acknowlegments:

    We thank Joshua Davidson (Octal540) for his critical discussion and his
    assistant drafting and optimizing pids.

    Redistribution, or reuse, with or without modifications
    shall keep this attribution information.
-->

<system>
  <channel name="Throttle EPR control">
    <fcs_function name="systems/fadec/engine/throttle-lever-target-epr">
      <function>
	<table>
	  <independentVar lookup="row">/controls/engines/engine/throttle</independentVar>
	  <independentVar lookup="column">instruments/engine-stdby/epr-rating/rating</independentVar>
	  <tableData>
                	1.0464	1.3379	1.5862	1.8266	2.0180
	    0.00	1.0464	1.0464	1.0464	1.0464	1.0464
	    0.05	1.0464	1.0471	1.0477	1.0483	1.0488
	    0.10	1.0464	1.0493	1.0517	1.0540	1.0559
	    0.15	1.0464	1.0529	1.0583	1.0637	1.0679
	    0.20	1.0464	1.0579	1.0676	1.0771	1.0846
	    0.25	1.0464	1.0643	1.0796	1.0943	1.1061
	    0.30	1.0464	1.0722	1.0942	1.1155	1.1324
	    0.35	1.0464	1.0815	1.1115	1.1404	1.1635
	    0.40	1.0464	1.0922	1.1313	1.1691	1.1992
	    0.45	1.0464	1.1045	1.1539	1.2018	1.2399
	    0.50	1.0464	1.1181	1.1791	1.2382	1.2853
	    0.55	1.0464	1.1331	1.2070	1.2785	1.3354
	    0.60	1.0464	1.1496	1.2375	1.3226	1.3904
	    0.65	1.0464	1.1675	1.2707	1.3706	1.4501
	    0.70	1.0464	1.1869	1.3065	1.4224	1.5146
	    0.75	1.0464	1.2076	1.3450	1.4779	1.5838
	    0.80	1.0464	1.2304	1.3871	1.5389	1.6597
	    0.85	1.0464	1.2535	1.4299	1.6007	1.7367
	    0.90	1.0464	1.2786	1.4763	1.6678	1.8203
	    0.95	1.0464	1.3051	1.5255	1.7388	1.9087
	    1.00	1.0464	1.3379	1.5862	1.8266	2.0180
	  </tableData>
	</table>
      </function>
    </fcs_function>
    
    <fcs_function name="systems/fadec/engine[1]/throttle-lever-target-epr">
      <function>
	<table>
	  <independentVar lookup="row">/controls/engines/engine[1]/throttle</independentVar>
	  <independentVar lookup="column">instruments/engine-stdby/epr-rating/rating</independentVar>
	  <tableData>
	                1.0464	1.3379	1.5862	1.8266	2.0180
	    0.00	1.0464	1.0464	1.0464	1.0464	1.0464
	    0.05	1.0464	1.0471	1.0477	1.0483	1.0488
	    0.10	1.0464	1.0493	1.0517	1.0540	1.0559
	    0.15	1.0464	1.0529	1.0583	1.0637	1.0679
	    0.20	1.0464	1.0579	1.0676	1.0771	1.0846
	    0.25	1.0464	1.0643	1.0796	1.0943	1.1061
	    0.30	1.0464	1.0722	1.0942	1.1155	1.1324
	    0.35	1.0464	1.0815	1.1115	1.1404	1.1635
	    0.40	1.0464	1.0922	1.1313	1.1691	1.1992
	    0.45	1.0464	1.1045	1.1539	1.2018	1.2399
	    0.50	1.0464	1.1181	1.1791	1.2382	1.2853
	    0.55	1.0464	1.1331	1.2070	1.2785	1.3354
	    0.60	1.0464	1.1496	1.2375	1.3226	1.3904
	    0.65	1.0464	1.1675	1.2707	1.3706	1.4501
	    0.70	1.0464	1.1869	1.3065	1.4224	1.5146
	    0.75	1.0464	1.2076	1.3450	1.4779	1.5838
	    0.80	1.0464	1.2304	1.3871	1.5389	1.6597
	    0.85	1.0464	1.2535	1.4299	1.6007	1.7367
	    0.90	1.0464	1.2786	1.4763	1.6678	1.8203
	    0.95	1.0464	1.3051	1.5255	1.7388	1.9087
	    1.00	1.0464	1.3379	1.5862	1.8266	2.0180
	  </tableData>
	</table>
      </function>
    </fcs_function>

    <fcs_function name="systems/fadec/engine[2]/throttle-lever-target-epr">
      <function>
	<table>
	  <independentVar lookup="row">/controls/engines/engine[2]/throttle</independentVar>
	  <independentVar lookup="column">instruments/engine-stdby/epr-rating/rating</independentVar>
	  <tableData>
	                1.0464	1.3379	1.5862	1.8266	2.0180
	    0.00	1.0464	1.0464	1.0464	1.0464	1.0464
	    0.05	1.0464	1.0471	1.0477	1.0483	1.0488
	    0.10	1.0464	1.0493	1.0517	1.0540	1.0559
	    0.15	1.0464	1.0529	1.0583	1.0637	1.0679
	    0.20	1.0464	1.0579	1.0676	1.0771	1.0846
	    0.25	1.0464	1.0643	1.0796	1.0943	1.1061
	    0.30	1.0464	1.0722	1.0942	1.1155	1.1324
	    0.35	1.0464	1.0815	1.1115	1.1404	1.1635
	    0.40	1.0464	1.0922	1.1313	1.1691	1.1992
	    0.45	1.0464	1.1045	1.1539	1.2018	1.2399
	    0.50	1.0464	1.1181	1.1791	1.2382	1.2853
	    0.55	1.0464	1.1331	1.2070	1.2785	1.3354
	    0.60	1.0464	1.1496	1.2375	1.3226	1.3904
	    0.65	1.0464	1.1675	1.2707	1.3706	1.4501
	    0.70	1.0464	1.1869	1.3065	1.4224	1.5146
	    0.75	1.0464	1.2076	1.3450	1.4779	1.5838
	    0.80	1.0464	1.2304	1.3871	1.5389	1.6597
	    0.85	1.0464	1.2535	1.4299	1.6007	1.7367
	    0.90	1.0464	1.2786	1.4763	1.6678	1.8203
	    0.95	1.0464	1.3051	1.5255	1.7388	1.9087
	    1.00	1.0464	1.3379	1.5862	1.8266	2.0180
	  </tableData>
	</table>
      </function>
    </fcs_function>

    <fcs_function name="systems/fadec/engine[3]/throttle-lever-target-epr">
      <function>
	<table>
	  <independentVar lookup="row">/controls/engines/engine[3]/throttle</independentVar>
	  <independentVar lookup="column">instruments/engine-stdby/epr-rating/rating</independentVar>
	  <tableData>
	                1.0464	1.3379	1.5862	1.8266	2.0180
	    0.00	1.0464	1.0464	1.0464	1.0464	1.0464
	    0.05	1.0464	1.0471	1.0477	1.0483	1.0488
	    0.10	1.0464	1.0493	1.0517	1.0540	1.0559
	    0.15	1.0464	1.0529	1.0583	1.0637	1.0679
	    0.20	1.0464	1.0579	1.0676	1.0771	1.0846
	    0.25	1.0464	1.0643	1.0796	1.0943	1.1061
	    0.30	1.0464	1.0722	1.0942	1.1155	1.1324
	    0.35	1.0464	1.0815	1.1115	1.1404	1.1635
	    0.40	1.0464	1.0922	1.1313	1.1691	1.1992
	    0.45	1.0464	1.1045	1.1539	1.2018	1.2399
	    0.50	1.0464	1.1181	1.1791	1.2382	1.2853
	    0.55	1.0464	1.1331	1.2070	1.2785	1.3354
	    0.60	1.0464	1.1496	1.2375	1.3226	1.3904
	    0.65	1.0464	1.1675	1.2707	1.3706	1.4501
	    0.70	1.0464	1.1869	1.3065	1.4224	1.5146
	    0.75	1.0464	1.2076	1.3450	1.4779	1.5838
	    0.80	1.0464	1.2304	1.3871	1.5389	1.6597
	    0.85	1.0464	1.2535	1.4299	1.6007	1.7367
	    0.90	1.0464	1.2786	1.4763	1.6678	1.8203
	    0.95	1.0464	1.3051	1.5255	1.7388	1.9087
	    1.00	1.0464	1.3379	1.5862	1.8266	2.0180
	  </tableData>
	</table>
      </function>
    </fcs_function>

    <switch name="systems/fadec/engine/running">
      <default value="/engines/engine/running"/>
    </switch>

    <switch name="systems/fadec/engine[1]/running">
      <default value="/engines/engine[1]/running"/>
    </switch>

    <switch name="systems/fadec/engine[2]/running">
      <default value="/engines/engine[2]/running"/>
    </switch>

    <switch name="systems/fadec/engine[3]/running">
      <default value="/engines/engine[3]/running"/>
    </switch>

    <switch name="systems/fadec/engine/epr">
      <default value="/engines/engine/epr"/>
    </switch>

    <switch name="systems/fadec/engine[1]/epr">
      <default value="/engines/engine[1]/epr"/>
    </switch>

    <switch name="systems/fadec/engine[2]/epr">
      <default value="/engines/engine[2]/epr"/>
    </switch>

    <switch name="systems/fadec/engine[3]/epr">
      <default value="/engines/engine[3]/epr"/>
    </switch>

    <fcs_function name="systems/fadec/engine/epr-err">
      <function>
	<difference>
	  <property>systems/fadec/engine/epr</property>
	  <property>systems/fadec/engine/throttle-lever-target-epr</property>
	</difference>
      </function>
    </fcs_function>

    <fcs_function name="systems/fadec/engine[1]/epr-err">
      <function>
	<difference>
	  <property>systems/fadec/engine[1]/epr</property>
	  <property>systems/fadec/engine[1]/throttle-lever-target-epr</property>
	</difference>
      </function>
    </fcs_function>

    <fcs_function name="systems/fadec/engine[2]/epr-err">
      <function>
	<difference>
	  <property>systems/fadec/engine[2]/epr</property>
	  <property>systems/fadec/engine[2]/throttle-lever-target-epr</property>
	</difference>
      </function>
    </fcs_function>

    <fcs_function name="systems/fadec/engine[3]/epr-err">
      <function>
	<difference>
	  <property>systems/fadec/engine[3]/epr</property>
	  <property>systems/fadec/engine[3]/throttle-lever-target-epr</property>
	</difference>
      </function>
    </fcs_function>
  </channel>


  <property value="24">systems/fadec/config/pid/kp</property>
  <property value="10">systems/fadec/config/pid/ki</property>
  <property value="0.5">systems/fadec/config/pid/kd</property>
  <channel name="PID throttle control">

    <!-- Winding logic -->
    <switch name="systems/fadec/engine/pid/pid-trigger">
      <default value="-1"/>
      <test value="0">
	systems/fadec/engine/running eq 1
      </test>
      <test logic="OR" value="1">
	systems/fadec/engine/pid/output lt -1
	systems/fadec/engine/pid/output gt 0
      </test>
    </switch>

    <switch name="systems/fadec/engine[1]/pid/pid-trigger">
      <default value="-1"/>
      <test value="0">
	systems/fadec/engine[1]/running eq 1
      </test>
      <test logic="OR" value="1">
	systems/fadec/engine[1]/pid/output lt -1
	systems/fadec/engine[1]/pid/output gt 0
      </test>
    </switch>
    
    <switch name="systems/fadec/engine[2]/pid/pid-trigger">
      <default value="-1"/>
      <test value="0">
	systems/fadec/engine[2]/running eq 1
      </test>
      <test logic="OR" value="1">
	systems/fadec/engine[2]/pid/output lt -1
	systems/fadec/engine[2]/pid/output gt 0
      </test>
    </switch>
    
    <switch name="systems/fadec/engine[3]/pid/pid-trigger">
      <default value="-1"/>
      <test value="0">
	systems/fadec/engine[3]/running eq 1
      </test>
      <test logic="OR" value="1">
	systems/fadec/engine[3]/pid/output lt -1
	systems/fadec/engine[3]/pid/output gt 0
      </test>
    </switch>
    
    <!-- PIDs-->
    <pid name="systems/fadec/engine/pid/output">
      <input>systems/fadec/engine/epr-err</input>
      <kp>systems/fadec/config/pid/kp</kp>
      <ki>systems/fadec/config/pid/ki</ki>
      <kd>systems/fadec/config/pid/kd</kd>
      <clipto>
	<min>-1</min>
	<max>0</max>
      </clipto>
      <trigger>systems/fadec/engine/pid/pid-trigger</trigger>
    </pid>

    <pid name="systems/fadec/engine[1]/pid/output">
      <input>systems/fadec/engine[1]/epr-err</input>
      <kp>systems/fadec/config/pid/kp</kp>
      <ki>systems/fadec/config/pid/ki</ki>
      <kd>systems/fadec/config/pid/kd</kd>
      <clipto>
	<min>-1</min>
	<max>0</max>
      </clipto>
      <trigger>systems/fadec/engine[1]/pid/pid-trigger</trigger>
    </pid>
    
    <pid name="systems/fadec/engine[2]/pid/output">
      <input>systems/fadec/engine[2]/epr-err</input>
      <kp>systems/fadec/config/pid/kp</kp>
      <ki>systems/fadec/config/pid/ki</ki>
      <kd>systems/fadec/config/pid/kd</kd>
      <clipto>
	<min>-1</min>
	<max>0</max>
      </clipto>
      <trigger>systems/fadec/engine[2]/pid/pid-trigger</trigger>
    </pid>
    
    <pid name="systems/fadec/engine[3]/pid/output">
      <input>systems/fadec/engine[3]/epr-err</input>
      <kp>systems/fadec/config/pid/kp</kp>
      <ki>systems/fadec/config/pid/ki</ki>
      <kd>systems/fadec/config/pid/kd</kd>
      <clipto>
	<min>-1</min>
	<max>0</max>
      </clipto>
      <trigger>systems/fadec/engine[3]/pid/pid-trigger</trigger>
    </pid>

    <!-- outputs -->
    <pure_gain name="systems/fadec/engine/pid/throttle-pos-norm">
      <input>systems/fadec/engine/pid/output</input>
      <gain>systems/fadec/engine/warnings/safe</gain>
      <output>fcs/throttle-pos-norm</output>
      <clipto>
	<min>0</min>
	<max>1</max>
      </clipto>
    </pure_gain>    

    <pure_gain name="systems/fadec/engine[1]/pid/throttle-pos-norm">
      <input>systems/fadec/engine[1]/pid/output</input>
      <gain>systems/fadec/engine[1]/warnings/safe</gain>
      <output>fcs/throttle-pos-norm[1]</output>
      <clipto>
	<min>0</min>
	<max>1</max>
      </clipto>
    </pure_gain>
    
    <pure_gain name="systems/fadec/engine[2]/pid/throttle-pos-norm">
      <input>systems/fadec/engine[2]/pid/output</input>
      <gain>systems/fadec/engine[2]/warnings/safe</gain>
      <output>fcs/throttle-pos-norm[2]</output>
      <clipto>
	<min>0</min>
	<max>1</max>
      </clipto>
    </pure_gain>
    
    <pure_gain name="systems/fadec/engine[3]/pid/throttle-pos-norm">
      <input>systems/fadec/engine[3]/pid/output</input>
      <gain>systems/fadec/engine[3]/warnings/safe</gain>
      <output>fcs/throttle-pos-norm[3]</output>
      <clipto>
	<min>0</min>
	<max>1</max>
      </clipto>
    </pure_gain>    
  </channel>

  <property value="0">systems/fadec/engine/warnings/extinguished</property>
  <property value="0">systems/fadec/engine[1]/warnings/extinguished</property>
  <property value="0">systems/fadec/engine[2]/warnings/extinguished</property>
  <property value="0">systems/fadec/engine[3]/warnings/extinguished</property>
  <channel name="Engines Warnings and failures">
    <switch name="systems/fadec/engine/warnings/eicas-warning">
      <default value="0"/>
      <test logic="OR" value="1">
	/engines/engine/n1 gt 99.80
      </test>
    </switch>

    <switch name="systems/fadec/engine[1]/warnings/eicas-warning">
      <default value="0"/>
      <test logic="OR" value="1">
	/engines/engine/n1 gt 99.80
      </test>
    </switch>

    <switch name="systems/fadec/engine[2]/warnings/eicas-warning">
      <default value="0"/>
      <test logic="OR" value="1">
	/engines/engine/n1 gt 99.80
      </test>
    </switch>

    <switch name="systems/fadec/engine[3]/warnings/eicas-warning">
      <default value="0"/>
      <test logic="OR" value="1">
	/engines/engine/n1 gt 99.80
      </test>
    </switch>
    
    <switch name="systems/fadec/engine/warnings/alert">
      <default value="0"/>
      <test logic="OR" value="1">
	systems/fadec/engine/warnings/eicas-warning eq 1
	/engines/engine/epr gt 1.9250
      </test>
    </switch>
    
    <switch name="systems/fadec/engine[1]/warnings/alert">
      <default value="0"/>
      <test logic="OR" value="1">
	systems/fadec/engine[1]/warnings/eicas-warning eq 1
	/engines/engine[1]/epr gt 1.9250
      </test>
    </switch>

    <switch name="systems/fadec/engine[2]/warnings/alert">
      <default value="0"/>
      <test logic="OR" value="1">
	systems/fadec/engine[2]/warnings/eicas-warning eq 1
	/engines/engine[2]/epr gt 1.9250
      </test>
    </switch>

    <switch name="systems/fadec/engine[3]/warnings/alert">
      <default value="0"/>
      <test logic="OR" value="1">
	systems/fadec/engine[3]/warnings/eicas-warning eq 1
	/engines/engine[3]/epr gt 1.9250
      </test>
    </switch>
    
    <kinematic name="Engine 1 warning timer">
      <input>systems/fadec/engine/warnings/alert</input>
      <traverse>
	<setting>
	  <position>0</position>
	  <time>600</time>
	</setting>
	<setting>
	  <position>1</position>
	  <time>1200</time>
	</setting>
      </traverse>
      <output>systems/fadec/engine/warnings/alert-timer</output>
    </kinematic>

    <kinematic name="Engine 2 warning timer">
      <input>systems/fadec/engine[1]/warnings/alert</input>
      <traverse>
	<setting>
	  <position>0</position>
	  <time>600</time>
	</setting>
	<setting>
	  <position>1</position>
	  <time>1200</time>
	</setting>
      </traverse>
      <output>systems/fadec/engine[1]/warnings/alert-timer</output>
    </kinematic>
    
    <kinematic name="Engine 3 warning timer">
      <input>systems/fadec/engine[2]/warnings/alert</input>
      <traverse>
	<setting>
	  <position>0</position>
	  <time>600</time>
	</setting>
	<setting>
	  <position>1</position>
	  <time>1200</time>
	</setting>
      </traverse>
      <output>systems/fadec/engine[2]/warnings/alert-timer</output>
    </kinematic>
    
    <kinematic name="Engine 4 warning timer">
      <input>systems/fadec/engine[3]/warnings/alert</input>
      <traverse>
	<setting>
	  <position>0</position>
	  <time>600</time>
	</setting>
	<setting>
	  <position>1</position>
	  <time>1200</time>
	</setting>
      </traverse>
      <output>systems/fadec/engine[3]/warnings/alert-timer</output>
    </kinematic>
    
    <switch name="systems/fadec/engine/warnings/failure-fire">
      <default value="0"/>
      <test value="0">
	systems/fadec/engine/warnings/extinguished eq 1
      </test>
      <test value="1">
	systems/fadec/engine/warnings/failure-fire eq 1
      </test>
      <test value="1">
	systems/fadec/engine/warnings/failure-fire-all eq 1
      </test>
      <test value="1">
	systems/fadec/engine/warnings/alert-timer ge 0.9980
      </test>
      <test value="0">
	systems/fadec/engine/warnings/alert-timer lt 0.9980
      </test>
    </switch>

    <switch name="systems/fadec/engine[1]/warnings/failure-fire">
      <default value="0"/>
      <test value="0">
	systems/fadec/engine[1]/warnings/extinguished eq 1
      </test>
      <test value="1">
	systems/fadec/engine[1]/warnings/failure-fire eq 1
      </test>
      <test value="1">
	systems/fadec/engine/warnings/failure-fire-all eq 1
      </test>
      <test value="1">
	systems/fadec/engine[1]/warnings/alert-timer ge 0.9980
      </test>
      <test value="0">
	systems/fadec/engine[1]/warnings/alert-timer lt 0.9980
      </test>
    </switch>

    <switch name="systems/fadec/engine[2]/warnings/failure-fire">
      <default value="0"/>
      <test value="0">
	systems/fadec/engine[2]/warnings/extinguished eq 1
      </test>
      <test value="1">
	systems/fadec/engine[2]/warnings/failure-fire eq 1
      </test>
      <test value="1">
	systems/fadec/engine/warnings/failure-fire-all eq 1
      </test>
      <test value="1">
	systems/fadec/engine[2]/warnings/alert-timer ge 0.9980
      </test>
      <test value="0">
	systems/fadec/engine[2]/warnings/alert-timer lt 0.9980
      </test>
    </switch>

    <switch name="systems/fadec/engine[3]/warnings/failure-fire">
      <default value="0"/>
      <test value="0">
	systems/fadec/engine[3]/warnings/extinguished eq 1
      </test>
      <test value="1">
	systems/fadec/engine[3]/warnings/failure-fire eq 1
      </test>
      <test value="1">
	systems/fadec/engine/warnings/failure-fire-all eq 1
      </test>
      <test value="1">
	systems/fadec/engine[3]/warnings/alert-timer ge 0.9980
      </test>
      <test value="0">
	systems/fadec/engine[3]/warnings/alert-timer lt 0.9980
      </test>
    </switch>
    
    <switch name="systems/fadec/engine/warnings/failure-warning">
      <default value="0"/>
      <test value="0">
	systems/fadec/engine/warnings/extinguished eq 1
      </test>
      <test value="0">
	systems/fadec/engine/warnings/alert-timer lt 0.250
      </test>
      <test logic="AND" value="1">
	systems/fadec/engine/warnings/failure-fire ne 1
	systems/fadec/engine/warnings/alert-timer ge 0.250
      </test>
    </switch>
    
    <switch name="systems/fadec/engine[1]/warnings/failure-warning">
      <default value="0"/>
      <test value="0">
	systems/fadec/engine/warnings/extinguished eq 1
      </test>
      <test value="0">
	systems/fadec/engine[1]/warnings/alert-timer lt 0.250
      </test>
      <test logic="AND" value="1">
	systems/fadec/engine[1]/warnings/failure-fire ne 1
	systems/fadec/engine[1]/warnings/alert-timer ge 0.250
      </test>
    </switch>
    
    <switch name="systems/fadec/engine[2]/warnings/failure-warning">
      <default value="0"/>
      <test value="0">
	systems/fadec/engine/warnings/extinguished eq 1
      </test>
      <test value="0">
	systems/fadec/engine[2]/warnings/alert-timer lt 0.250
      </test>
      <test logic="AND" value="1">
	systems/fadec/engine[2]/warnings/failure-fire ne 1
	systems/fadec/engine[2]/warnings/alert-timer ge 0.250
      </test>
    </switch>
    
    <switch name="systems/fadec/engine[3]/warnings/failure-warning">
      <default value="0"/>
      <test value="0">
	systems/fadec/engine/warnings/extinguished eq 1
      </test>
      <test value="0">
	systems/fadec/engine[3]/warnings/alert-timer lt 0.250
      </test>
      <test logic="AND" value="1">
	systems/fadec/engine[3]/warnings/failure-fire ne 1
	systems/fadec/engine[3]/warnings/alert-timer ge 0.250
      </test>
    </switch>
    
    <kinematic name="Engine 1 fire all engines fire timer">
      <input>systems/fadec/engine/warnings/failure-fire</input>
      <traverse>
	<setting>
	  <position>0</position>
	  <time>180</time>
	</setting>
	<setting>
	  <position>1</position>
	  <time>180</time>
	</setting>
      </traverse>
      <output>systems/fadec/engine/warnings/all-fire-timer</output>
    </kinematic>

    <kinematic name="Engine 2 fire all engines fire timer">
      <input>systems/fadec/engine[1]/warnings/failure-fire</input>
      <traverse>
	<setting>
	  <position>0</position>
	  <time>180</time>
	</setting>
	<setting>
	  <position>1</position>
	  <time>180</time>
	</setting>
      </traverse>
      <output>systems/fadec/engine[1]/warnings/all-fire-timer</output>
    </kinematic>
    
    <kinematic name="Engine 3 fire all engines fire timer">
      <input>systems/fadec/engine[2]/warnings/failure-fire</input>
      <traverse>
	<setting>
	  <position>0</position>
	  <time>180</time>
	</setting>
	<setting>
	  <position>1</position>
	  <time>180</time>
	</setting>
      </traverse>
      <output>systems/fadec/engine[2]/warnings/all-fire-timer</output>
    </kinematic>
    
    <kinematic name="Engine 4 fire all engines fire timer">
      <input>systems/fadec/engine[3]/warnings/failure-fire</input>
      <traverse>
	<setting>
	  <position>0</position>
	  <time>180</time>
	</setting>
	<setting>
	  <position>1</position>
	  <time>180</time>
	</setting>
      </traverse>
      <output>systems/fadec/engine[3]/warnings/all-fire-timer</output>
    </kinematic>
    
    <switch name="systems/fadec/engine/warnings/failure-fire-all">
      <default value="0"/>
      <test value="1">
	systems/fadec/engine/warnings/failure-fire-all eq 1
      </test>
      <test logic="OR" value="1">
	systems/fadec/engine/warnings/all-fire-timer eq 1
	systems/fadec/engine[1]/warnings/all-fire-timer eq 1
	systems/fadec/engine[2]/warnings/all-fire-timer eq 1
	systems/fadec/engine[3]/warnings/all-fire-timer eq 1
      </test>
      <test logic="OR" value="0">
	systems/fadec/engine/warnings/all-fire-timer lt 1
	systems/fadec/engine[1]/warnings/all-fire-timer lt 1
	systems/fadec/engine[2]/warnings/all-fire-timer lt 1
	systems/fadec/engine[3]/warnings/all-fire-timer lt 1
      </test>
    </switch>

    <!-- Engine failure -->
    <switch name="/engines/engine/running">
      <default value="/engines/engine/running"/>
      <test logic="OR" value="0">
	systems/fadec/engine/warnings/failure-fire eq 1	
	systems/fadec/engine/warnings/extinguished eq 1
      </test>
    </switch>

    <switch name="systems/fadec/engine/warnings/safe">
      <default value="-1"/>
      <test  logic="OR" value="0">
	systems/fadec/engine/warnings/failure-fire eq 1	
	systems/fadec/engine/warnings/extinguished eq 1
      </test>
    </switch>

    <switch name="/engines/engine[1]/running">
      <default value="/engines/engine[1]/running"/>
      <test  logic="OR" value="0">
	systems/fadec/engine[1]/warnings/failure-fire eq 1	
	systems/fadec/engine[1]/warnings/extinguished eq 1
      </test>
    </switch>

    <switch name="systems/fadec/engine[1]/warnings/safe">
      <default value="-1"/>
      <test  logic="OR" value="0">
	systems/fadec/engine[1]/warnings/failure-fire eq 1	
	systems/fadec/engine[1]/warnings/extinguished eq 1
      </test>
    </switch>

    <switch name="/engines/engine[2]/running">
      <default value="/engines/engine[2]/running"/>
      <test  logic="OR" value="0">
	systems/fadec/engine[2]/warnings/failure-fire eq 1	
	systems/fadec/engine[2]/warnings/extinguished eq 1
      </test>
    </switch>

    <switch name="systems/fadec/engine[2]/warnings/safe">
      <default value="-1"/>
      <test  logic="OR" value="0">
	systems/fadec/engine[2]/warnings/failure-fire eq 1	
	systems/fadec/engine[2]/warnings/extinguished eq 1
      </test>
    </switch>

    <switch name="/engines/engine[3]/running">
      <default value="/engines/engine[3]/running"/>
      <test  logic="OR" value="0">
	systems/fadec/engine[3]/warnings/failure-fire eq 1	
	systems/fadec/engine[3]/warnings/extinguished eq 1
      </test>
    </switch>

    <switch name="systems/fadec/engine[3]/warnings/safe">
      <default value="-1"/>
      <test  logic="OR" value="0">
	systems/fadec/engine[3]/warnings/failure-fire eq 1	
	systems/fadec/engine[3]/warnings/extinguished eq 1
      </test>
    </switch>
  </channel>

  <channel name="EPR rating protection">
    <!-- MCT and DRT with overspeed rating protection -->
    <fcs_function name="systems/fadec/RTGCap/n1-1-err">
      <function>
	<difference>
	  <property>/engines/engine/n1</property>
	  <value>99.65</value>
	</difference>
      </function>
    </fcs_function>
    
    <fcs_function name="systems/fadec/RTGCap/n1-2-err">
      <function>
	<difference>
	  <property>/engines/engine[1]/n1</property>
	  <value>99.65</value>
	</difference>
      </function>
    </fcs_function>
    
    <fcs_function name="systems/fadec/RTGCap/n1-3-err">
      <function>
	<difference>
	  <property>/engines/engine[2]/n1</property>
	  <value>99.65</value>
	</difference>
      </function>
    </fcs_function>
    
    <fcs_function name="systems/fadec/RTGCap/n1-4-err">
      <function>
	<difference>
	  <property>/engines/engine[3]/n1</property>
	  <value>99.65</value>
	</difference>
      </function>
    </fcs_function>

    <fcs_function name="systems/fadec/RTGCap/n1-top-err">
      <function>
	<max>
	  <property>systems/fadec/RTGCap/n1-1-err</property>
	  <property>systems/fadec/RTGCap/n1-2-err</property>
	  <property>systems/fadec/RTGCap/n1-3-err</property>
	  <property>systems/fadec/RTGCap/n1-4-err</property>
	</max>
      </function>
    </fcs_function>

    <switch name="systems/fadec/RTGCap/n1-excess">
      <!-- Is any N1 greater than 99.65? -->
      <default value="0"/>
      <test value="1">
	systems/fadec/RTGCap/n1-top-err gt 0
      </test>
    </switch>

    <switch name="systems/fadec/RTGCap/n1-safe">
      <!-- Are all N1 lower than 95.0? -->
      <default value="0"/>
      <test logic="AND" value="1">
	/engines/engine/n1 lt 95.0
	/engines/engine[1]/n1 lt 95.0
	/engines/engine[2]/n1 lt 95.0
	/engines/engine[3]/n1 lt 95.0
      </test>
    </switch>

    <switch name="systems/fadec/RTGCap/mct-rating-tgt">
      <default value="instruments/engine-stdby/epr-rating/mct-rating"/>
      <test logic="AND" value="1.04">
	instruments/engine-stdby/display/epr-mode eq 2
	systems/fadec/RTGCap/n1-excess eq 1
      </test>
      <test logic="AND"
	    value="instruments/engine-stdby/epr-rating/mct-rating">
	instruments/engine-stdby/display/epr-mode eq 2
	systems/fadec/RTGCap/n1-safe eq 1
      </test>
      <test logic="AND"
	    value="systems/fadec/RTGCap/mct-rating-capped">
	instruments/engine-stdby/display/epr-mode eq 2
	systems/fadec/RTGCap/n1-safe eq 0
	systems/fadec/RTGCap/n1-excess eq 0
      </test>
    </switch>

    <switch name="systems/fadec/RTGCap/drt-rating-tgt">
      <default value="instruments/engine-stdby/epr-rating/drt-rating"/>
      <test logic="AND" value="1.04">
	instruments/engine-stdby/display/epr-mode eq 3
	systems/fadec/RTGCap/n1-excess eq 1
      </test>
      <test logic="AND"
	    value="instruments/engine-stdby/epr-rating/drt-rating">
	instruments/engine-stdby/display/epr-mode eq 3
	systems/fadec/RTGCap/n1-safe eq 1
      </test>
      <test logic="AND"
	    value="systems/fadec/RTGCap/drt-rating-capped">
	instruments/engine-stdby/display/epr-mode eq 3
	systems/fadec/RTGCap/n1-safe eq 0
	systems/fadec/RTGCap/n1-excess eq 0
      </test>
    </switch>

    <kinematic name="MCT rating cap protection">
      <input>systems/fadec/RTGCap/mct-rating-tgt</input>
      <noscale/>
      <traverse>
	<setting>
	  <position>1.04</position>
	  <time>12</time>
	</setting>
	<setting>
	  <position>2.04</position>
	  <time>12</time>
	</setting>
      </traverse>
      <output>systems/fadec/RTGCap/mct-rating-capped</output>
    </kinematic>

    <kinematic name="DRT rating cap protection">
      <input>systems/fadec/RTGCap/drt-rating-tgt</input>
      <noscale/>
      <traverse>
	<setting>
	  <position>1.04</position>
	  <time>12</time>
	</setting>
	<setting>
	  <position>2.04</position>
	  <time>12</time>
	</setting>
      </traverse>
      <output>systems/fadec/RTGCap/drt-rating-capped</output>
    </kinematic>
  </channel>

  <channel name="EPR mode Reduction in modes MAX and INT">
    <!-- 
	 In modes MAX and INT, if throttle is brought up to maximum,
	 it primes the reduction. Throttle reduction to 95% shifts down to
	 protected MCT mode. 
    -->

    <fcs_function name="systems/fadec/RTGRed/max-throttle">
      <function>
	<max>
	  <property>/controls/engines/engine/throttle</property>
	  <property>/controls/engines/engine[1]/throttle</property>
	  <property>/controls/engines/engine[2]/throttle</property>
	  <property>/controls/engines/engine[3]/throttle</property>
	</max>
      </function>
    </fcs_function>

    <switch name="systems/fadec/RTGRed/reduceable-mode">
      <default value="0"/>
      <test logic="OR" value="1">
	instruments/engine-stdby/display/epr-mode eq 0
	instruments/engine-stdby/display/epr-mode eq 1
      </test>
    </switch>
    
    <switch name="systems/fadec/RTGRed/primed">
      <default value="0"/>
      <test value="1">
	systems/fadec/RTGRed/primed eq 1
      </test>
      <test value="1">
	systems/fadec/RTGRed/reduceable-mode eq 1
	systems/fadec/RTGRed/max-throttle eq 1
      </test>
    </switch>

    <switch name="instruments/engine-stdby/display/epr-mode">
      <default value="instruments/engine-stdby/display/epr-mode"/>
      <test logic="AND" value="2">
	systems/fadec/RTGRed/max-throttle le 0.95
	systems/fadec/RTGRed/reduceable-mode eq 1
	systems/fadec/RTGRed/primed eq 1
      </test>
    </switch>
  </channel>
</system>
