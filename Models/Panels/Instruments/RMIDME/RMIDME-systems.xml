<?xml version="1.0"?>
<?xml-stylesheet href="JSBSim.xsl" type="application/xml"?>

<!--
:copyright: 2023, IAHM-COL
License: GPLv3

Redistribution, or reuse, with or without modifications
shall keep this attribution information. 
-->

<system>
  <!-- ch1 select; 0:VOR, 1:VOR_TAC, 2: ADF -->
  <property value="0">instruments/RMIDME/ch1/select</property>
  <!-- ch1 select; 0:VOR, 1:VOR_TAC, 2: ADF -->
  <property value="0">instruments/RMIDME/ch2/select</property>
  <!-- heading knob offset -->
  <property value="0">instruments/RMIDME/heading-offset</property>
  <!-- initial values for the nav stack -->
  <property value="117.15">/instrumentation/nav[2]/frequencies/selected-mhz</property> 
  <property value="113.80">/instrumentation/nav[2]/frequencies/standby-mhz</property>
  <property value="284">/instrumentation/nav[2]/radials/selected-deg</property>
  <property value="112.10">/instrumentation/nav[3]/frequencies/selected-mhz</property> 
  <property value="115.20">/instrumentation/nav[3]/frequencies/standby-mhz</property> 
  <property value="326">/instrumentation/nav[3]/radials/selected-deg</property>
  <property value="117.15">/instrumentation/nav[4]/frequencies/selected-mhz</property> 
  <property value="113.80">/instrumentation/nav[4]/frequencies/standby-mhz</property>
  <property value="284">/instrumentation/nav[4]/radials/selected-deg</property>
  <property value="112.10">/instrumentation/nav[5]/frequencies/selected-mhz</property> 
  <property value="115.20">/instrumentation/nav[5]/frequencies/standby-mhz</property> 
  <property value="326">/instrumentation/nav[5]/radials/selected-deg</property>
  <property value="117.15">/instrumentation/nav[6]/frequencies/selected-mhz</property> 
  <property value="113.80">/instrumentation/nav[6]/frequencies/standby-mhz</property>
  <property value="284">/instrumentation/nav[6]/radials/selected-deg</property>

  <!-- Somehow the second instance of adf fails electrical output creation -->
  <channel name="activate adf1 electrical">
    <switch name="/systems/electrical/outputs/adf[1]">
      <default value="/systems/electrical/outputs/adf"/>
    </switch>
    <switch name="/systems/electrical/outputs/adf[2]">
      <default value="/systems/electrical/outputs/adf"/>
    </switch>
  </channel>

  <channel name="ADF">
    <switch name="instruments/RMIDME/ch1/adf/flag">
      <default value="0"/>
      <test value="1">
	/instrumentation/adf/operable eq 0
      </test>
      <test value="1">
	/instrumentation/adf/in-range eq 0
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch1/adf/bearing">
      <default value="/instrumentation/adf/indicated-bearing-deg"/>
      <test value="0">
	instruments/RMIDME/ch1/adf/flag eq 1
      </test>
    </switch>

    <fcs_function name="instruments/RMIDME/ch1/adf/signal-rotation">
      <function>
	<product>
	    <property>instruments/RMIDME/ch1/adf/bearing</property>
	    <value>-1</value>
	</product>
      </function>
    </fcs_function>

    <switch name="instruments/RMIDME/ch2/adf/flag">
      <default value="0"/>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/adf[1]/operable eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/adf[1]/in-range eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/adf[2]/operable eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/adf[2]/in-range eq 0
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch2/adf/bearing">
      <default value="/instrumentation/adf[1]/indicated-bearing-deg"/>
      <test logic="AND" value="0">
	instruments/RMIDME/channel/selected ne 2
	instruments/RMIDME/ch2/adf/flag eq 1
      </test>
      <test logic="AND" value="0">
	instruments/RMIDME/channel/selected eq 2
	instruments/RMIDME/ch2/adf/flag eq 1
      </test>
      <test logic="AND" value="/instrumentation/adf[2]/indicated-bearing-deg">
	instruments/RMIDME/channel/selected eq 2
	instruments/RMIDME/ch2/adf/flag eq 0
      </test>
    </switch>

    <fcs_function name="instruments/RMIDME/ch2/adf/signal-rotation">
      <function>
	<product>
	    <property>instruments/RMIDME/ch2/adf/bearing</property>
	    <value>-1</value>
	</product>
      </function>
    </fcs_function>
  </channel>

  <channel name="VOR">
    <switch name="instruments/RMIDME/ch1/vor/flag">
      <default value="0"/>
      <test value="1">
	/instrumentation/nav[1]/operable eq 0
      </test>
      <test value="1">
	/instrumentation/nav[1]/in-range eq 0
      </test>
      <test value="1">
	/instrumentation/nav[1]/data-is-valid eq 0
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch1/vor/data-is-valid">
      <default value="/instrumentation/nav[1]/data-is-valid"/>
    </switch>

    <fcs_function name="instruments/RMIDME/ch1/vor/bearing-direct">
      <function>
	<difference>
	  <property>/instrumentation/nav[1]/heading-deg</property>
	  <property>/orientation/heading-magnetic-deg</property>
	</difference>
      </function>
    </fcs_function>

    <fcs_function name="instruments/RMIDME/ch1/vor/bearing-corrected">
      <function>
	<ifthen>
	  <lt>
	    <property>instruments/RMIDME/ch1/vor/bearing-direct</property>
	    <value>0</value>
	  </lt>
	  <sum>
	    <property>instruments/RMIDME/ch1/vor/bearing-direct</property>
	    <value>360</value>
	  </sum>
	  <property>instruments/RMIDME/ch1/vor/bearing-direct</property>
	</ifthen>
      </function>
    </fcs_function>

    <switch name="instruments/RMIDME/ch1/vor/bearing">
      <default value="0"/>
      <test value="instruments/RMIDME/ch1/vor/bearing-corrected">
	/instrumentation/nav[1]/data-is-valid eq 1
      </test>
    </switch>

    <fcs_function name="instruments/RMIDME/ch1/vor/signal-rotation">
      <function>
	<product>
	  <property>instruments/RMIDME/ch1/vor/bearing</property>
	  <value>-1</value>
	</product>
      </function>
    </fcs_function>

    <fcs_function name="instruments/RMIDME/ch1/vor/nav-distance-nm">
      <function>
	<product>
	  <property>/instrumentation/nav[1]/nav-distance</property>
	  <value>0.0005399568</value>
	</product>
      </function>
    </fcs_function>
    
    <switch name="instruments/RMIDME/ch1/vor/dme">
      <default value="instruments/RMIDME/ch1/vor/nav-distance-nm"/>
      <test value="0">
	instruments/RMIDME/ch1/vor/data-is-valid eq 0
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch2/vor/flag">
      <default value="0"/>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/nav[3]/operable eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/nav[3]/in-range eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/nav[3]/data-is-valid eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/nav[5]/operable eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/nav[5]/in-range eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/nav[5]/data-is-valid eq 0
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch2/vor/data-is-valid">
      <default value="/instrumentation/nav[3]/data-is-valid"/>
      <test value="/instrumentation/nav[5]/data-is-valid">
	instruments/RMIDME/channel/selected eq 2
      </test>
    </switch>

    <fcs_function name="instruments/RMIDME/ch2/vor/bearing-direct">
      <function>
	<ifthen>
	  <lt>
	    <property>instruments/RMIDME/channel/selected</property>
	    <value>1</value>
	  </lt>
	  <difference>
	    <property>/instrumentation/nav[3]/heading-deg</property>
	    <property>/orientation/heading-magnetic-deg</property>
	  </difference>
	  <difference>
	    <property>/instrumentation/nav[5]/heading-deg</property>
	    <property>/orientation/heading-magnetic-deg</property>
	  </difference>
	</ifthen>
      </function>
    </fcs_function>

    <fcs_function name="instruments/RMIDME/ch2/vor/bearing-corrected">
      <function>
	<ifthen>
	  <lt>
	    <property>instruments/RMIDME/ch2/vor/bearing-direct</property>
	    <value>0</value>
	  </lt>
	  <sum>
	    <property>instruments/RMIDME/ch2/vor/bearing-direct</property>
	    <value>360</value>
	  </sum>
	  <property>instruments/RMIDME/ch2/vor/bearing-direct</property>
	</ifthen>
      </function>
    </fcs_function>

    <switch name="instruments/RMIDME/ch2/vor/bearing">
      <default value="0"/>
      <test logic="AND" value="instruments/RMIDME/ch2/vor/bearing-corrected">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/nav[3]/data-is-valid eq 1
      </test>
      <test logic="AND" value="instruments/RMIDME/ch2/vor/bearing-corrected">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/nav[5]/data-is-valid eq 1
      </test>
    </switch>

    <fcs_function name="instruments/RMIDME/ch2/vor/signal-rotation">
      <function>
	<product>
	  <property>instruments/RMIDME/ch2/vor/bearing</property>
	  <value>-1</value>
	</product>
      </function>
    </fcs_function>
    
    <fcs_function name="instruments/RMIDME/ch2/vor/nav-distance-nm">
      <function>
	<ifthen>
	  <lt>
	    <property>instruments/RMIDME/channel/selected</property>
	    <value>1</value>
	  </lt>
	  <product>
	    <property>/instrumentation/nav[3]/nav-distance</property>
	    <value>0.0005399568</value>
	  </product>
	  <product>
	    <property>/instrumentation/nav[5]/nav-distance</property>
	    <value>0.0005399568</value>
	  </product>
	</ifthen>
      </function>
    </fcs_function>

    <switch name="instruments/RMIDME/ch2/vor/dme">
      <default value="instruments/RMIDME/ch2/vor/nav-distance-nm"/>
      <test value="0">
	instruments/RMIDME/ch2/vor/data-is-valid eq 0
      </test>
    </switch>
  </channel>




  <channel name="TAC">
    <switch name="instruments/RMIDME/ch1/tac/flag">
      <default value="0"/>
      <test value="1">
	/instrumentation/nav[2]/operable eq 0
      </test>
      <test value="1">
	/instrumentation/nav[2]/in-range eq 0
      </test>
      <test value="1">
	/instrumentation/nav[2]/data-is-valid eq 0
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch1/tac/data-is-valid">
      <default value="/instrumentation/nav[2]/data-is-valid"/>
    </switch>

    <fcs_function name="instruments/RMIDME/ch1/tac/bearing-direct">
      <function>
	<difference>
	  <property>/instrumentation/nav[2]/heading-deg</property>
	  <property>/orientation/heading-magnetic-deg</property>
	</difference>
      </function>
    </fcs_function>

    <fcs_function name="instruments/RMIDME/ch1/tac/bearing-corrected">
      <function>
	<ifthen>
	  <lt>
	    <property>instruments/RMIDME/ch1/tac/bearing-direct</property>
	    <value>0</value>
	  </lt>
	  <sum>
	    <property>instruments/RMIDME/ch1/tac/bearing-direct</property>
	    <value>360</value>
	  </sum>
	  <property>instruments/RMIDME/ch1/tac/bearing-direct</property>
	</ifthen>
      </function>
    </fcs_function>

    <switch name="instruments/RMIDME/ch1/tac/bearing">
      <default value="0"/>
      <test value="instruments/RMIDME/ch1/tac/bearing-corrected">
	/instrumentation/nav[2]/data-is-valid eq 1
      </test>
    </switch>

    <fcs_function name="instruments/RMIDME/ch1/tac/signal-rotation">
      <function>
	<product>
	  <property>instruments/RMIDME/ch1/tac/bearing</property>
	  <value>-1</value>
	</product>
      </function>
    </fcs_function>

    <fcs_function name="instruments/RMIDME/ch1/tac/nav-distance-nm">
      <function>
	<product>
	  <property>/instrumentation/nav[2]/nav-distance</property>
	  <value>0.0005399568</value>
	</product>
      </function>
    </fcs_function>
    
    <switch name="instruments/RMIDME/ch1/tac/dme">
      <default value="instruments/RMIDME/ch1/tac/nav-distance-nm"/>
      <test value="0">
	instruments/RMIDME/ch1/tac/data-is-valid eq 0
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch2/tac/flag">
      <default value="0"/>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/nav[4]/operable eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/nav[4]/in-range eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/nav[4]/data-is-valid eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/nav[6]/operable eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/nav[6]/in-range eq 0
      </test>
      <test logic="AND" value="1">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/nav[6]/data-is-valid eq 0
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch2/tac/data-is-valid">
      <default value="/instrumentation/nav[4]/data-is-valid"/>
      <test value="/instrumentation/nav[6]/data-is-valid">
	instruments/RMIDME/channel/selected eq 2
      </test>
    </switch>

    <fcs_function name="instruments/RMIDME/ch2/tac/bearing-direct">
      <function>
	<ifthen>
	  <lt>
	    <property>instruments/RMIDME/channel/selected</property>
	    <value>1</value>
	  </lt>
	  <difference>
	    <property>/instrumentation/nav[4]/heading-deg</property>
	    <property>/orientation/heading-magnetic-deg</property>
	  </difference>
	  <difference>
	    <property>/instrumentation/nav[6]/heading-deg</property>
	    <property>/orientation/heading-magnetic-deg</property>
	  </difference>
	</ifthen>
      </function>
    </fcs_function>

    <fcs_function name="instruments/RMIDME/ch2/tac/bearing-corrected">
      <function>
	<ifthen>
	  <lt>
	    <property>instruments/RMIDME/ch2/tac/bearing-direct</property>
	    <value>0</value>
	  </lt>
	  <sum>
	    <property>instruments/RMIDME/ch2/tac/bearing-direct</property>
	    <value>360</value>
	  </sum>
	  <property>instruments/RMIDME/ch2/tac/bearing-direct</property>
	</ifthen>
      </function>
    </fcs_function>

    <switch name="instruments/RMIDME/ch2/tac/bearing">
      <default value="0"/>
      <test logic="AND" value="instruments/RMIDME/ch2/tac/bearing-corrected">
	instruments/RMIDME/channel/selected ne 2
	/instrumentation/nav[4]/data-is-valid eq 1
      </test>
      <test logic="AND" value="instruments/RMIDME/ch2/tac/bearing-corrected">
	instruments/RMIDME/channel/selected eq 2
	/instrumentation/nav[6]/data-is-valid eq 1
      </test>
    </switch>

    <fcs_function name="instruments/RMIDME/ch2/tac/signal-rotation">
      <function>
	<product>
	  <property>instruments/RMIDME/ch2/tac/bearing</property>
	  <value>-1</value>
	</product>
      </function>
    </fcs_function>
    
    <fcs_function name="instruments/RMIDME/ch2/tac/nav-distance-nm">
      <function>
	<ifthen>
	  <lt>
	    <property>instruments/RMIDME/channel/selected</property>
	    <value>1</value>
	  </lt>
	  <product>
	    <property>/instrumentation/nav[4]/nav-distance</property>
	    <value>0.0005399568</value>
	  </product>
	  <product>
	    <property>/instrumentation/nav[6]/nav-distance</property>
	    <value>0.0005399568</value>
	  </product>
	</ifthen>
      </function>
    </fcs_function>

    <switch name="instruments/RMIDME/ch2/tac/dme">
      <default value="instruments/RMIDME/ch2/tac/nav-distance-nm"/>
      <test value="0">
	instruments/RMIDME/ch2/tac/data-is-valid eq 0
      </test>
    </switch>
  </channel>

  <channel name="Display">
    <switch name="instruments/RMIDME/ch1/display/flag">
      <default value="0"/>
      <test value="instruments/RMIDME/ch1/adf/flag">
	instruments/RMIDME/ch1/select eq 2
      </test>
      <test value="instruments/RMIDME/ch1/vor/flag">
	instruments/RMIDME/ch1/select eq 0
      </test>
      <test value="instruments/RMIDME/ch1/tac/flag">
	instruments/RMIDME/ch1/select eq 1
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch1/display/signal-rotation">
      <default value="0"/>
      <test value="instruments/RMIDME/ch1/adf/signal-rotation">
	instruments/RMIDME/ch1/select eq 2
      </test>
      <test logic="AND" value="instruments/RMIDME/ch1/vor/signal-rotation">
	instruments/RMIDME/ch1/select eq 0
	instruments/RMIDME/ch1/vor/flag eq 0
      </test>
      <test logic="AND" value="instruments/RMIDME/ch1/tac/signal-rotation">
	instruments/RMIDME/ch1/select eq 1
	instruments/RMIDME/ch1/tac/flag eq 0
      </test>
    </switch>
    
    <switch name="instruments/RMIDME/ch1/display/dme">
      <default value="0"/>
      <test logic="AND" value="instruments/RMIDME/ch1/vor/dme">
	instruments/RMIDME/ch1/select eq 0
	instruments/RMIDME/ch1/vor/flag eq 0
      </test>
      <test logic="AND" value="instruments/RMIDME/ch1/tac/dme">
	instruments/RMIDME/ch1/select eq 1
	instruments/RMIDME/ch1/tac/flag eq 0
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch2/display/flag">
      <default value="0"/>
      <test value="instruments/RMIDME/ch2/adf/flag">
	instruments/RMIDME/ch2/select eq 2
      </test>
      <test value="instruments/RMIDME/ch2/vor/flag">
	instruments/RMIDME/ch2/select eq 0
      </test>
      <test value="instruments/RMIDME/ch2/tac/flag">
	instruments/RMIDME/ch2/select eq 1
      </test>
    </switch>

    <switch name="instruments/RMIDME/ch2/display/signal-rotation">
      <default value="0"/>
      <test value="instruments/RMIDME/ch2/adf/signal-rotation">
	instruments/RMIDME/ch2/select eq 2
      </test>
      <test logic="AND" value="instruments/RMIDME/ch2/vor/signal-rotation">
	instruments/RMIDME/ch2/select eq 0
	instruments/RMIDME/ch2/vor/flag eq 0
      </test>
      <test logic="AND" value="instruments/RMIDME/ch2/tac/signal-rotation">
	instruments/RMIDME/ch2/select eq 1
	instruments/RMIDME/ch2/tac/flag eq 0
      </test>
    </switch>
    
    <switch name="instruments/RMIDME/ch2/display/dme">
      <default value="0"/>
      <test logic="AND" value="instruments/RMIDME/ch2/vor/dme">
	instruments/RMIDME/ch2/select eq 0
	instruments/RMIDME/ch2/vor/flag eq 0
      </test>
      <test logic="AND" value="instruments/RMIDME/ch2/tac/dme">
	instruments/RMIDME/ch2/select eq 1
	instruments/RMIDME/ch2/tac/flag eq 0
      </test>
    </switch>
  </channel>

  <!-- channel/switch; 0: ch2. 1: default. 2: ch3 -->
  <property value="1">instruments/RMIDME/channel/switch</property>
  <property value="1">instruments/RMIDME/channel/inop</property>
  <channel name="Alternative Channel Selector">
    <!-- INOP: selected remains 0, regardless of switch position
	 NO INOP: Selected channel based on switch position
    -->
    <switch name="instruments/RMIDME/channel/selected">
      <default value="0"/>
      <test value="instruments/RMIDME/channel/switch">
	instruments/RMIDME/channel/inop eq 0
      </test>
    </switch>
  </channel>
</system>
